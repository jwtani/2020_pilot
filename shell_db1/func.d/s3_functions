# -*-Shell-script-*-
#
# s3_functions This file contains functions that are called when using Amazon S3
#       in shell scripts in the /home/jw/data-linkage directory.
#

PATH="/sbin:/usr/sbin:/usr/local/bin:/bin:/usr/bin"
export PATH

# AmazonS3アップロード
function s3upload() {
    # 第１引数：アップロード対象ファイル
    local target_file=$1

    # 第２引数：S3アップロード後のファイルkey
    local s3_key=$2

    # 第３引数：S3バケット名
    local bucket_name=$3

    # 第４引数：コマンドを実行するプロファイル
    local profile=$4

    # 対象ファイルのMD5ハッシュ値
    local hash_value

    # 直前のコマンド終了ステータス
    local return_code=0

    # エラー：引数の数が４以外
    if [ $# -ne 4 ]; then
        echo ERROR: Invalid argument count. Specify four arguments. \<target_file\> \<s3_key\> \<bucket_name\> \<profile\>
        exit 1
    fi

    # エラー：存在しないファイル
    if [ ! -e ${target_file} ]; then
        echo ERROR: ${target_file} is not found. Please specify a valid file path.
        exit 1
    fi

    # エラー：ディレクトリが指定された
    if [ -d ${target_file} ]; then
        echo ERROR: ${target_file} is directory. Please specify a valid file path.
        exit 1
    fi

    # 対象ファイルのMD5ハッシュ値を取得
    hash_value=`openssl md5 -binary ${target_file} | base64`
    return_code=$?

    # エラー：MD5ハッシュ値取得に失敗
    if [ ${return_code} -ne 0 ]; then
        echo ERROR: Faild to get ${target_file} md5checksum.
        exit 1
    fi

    # S3へアップロード
    return_error=`aws s3api put-object --bucket ${bucket_name} --key ${s3_key} --body ${target_file} --content-md5 ${hash_value} --metadata md5checksum=${hash_value} --profile ${profile} 2>&1 >/dev/null`
    return_code=$?

    # エラー：S3へのファイルアップロードに失敗
    if [ ${return_code} -ne 0 ]; then
        echo ${return_error}
        exit 1
    fi 

    exit 0
}

# AmazonS3ダウンロード
function s3download() {
    echo This is Amazon S3 download function. [Coming soon]
    exit 0
}
